name: Main CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  setup:
    uses: ./.github/workflows/01-setup.yml
    secrets: inherit
    with:
      node-version: '20'

  lint:
    needs: setup
    uses: ./.github/workflows/02-lint.yml
    secrets: inherit
    with:
      cache-key: ${{ needs.setup.outputs.cache-key }}
      node-version: '20'

  test:
    needs: [setup, lint]
    uses: ./.github/workflows/03-test.yml
    secrets: inherit
    with:
      cache-key: ${{ needs.setup.outputs.cache-key }}
      node-version: '20'

  build:
    needs: [setup, test]
    uses: ./.github/workflows/04-build.yml
    secrets: inherit
    with:
      cache-key: ${{ needs.setup.outputs.cache-key }}
      node-version: '20'
      commit-sha: ${{ github.sha }}

  deploy:
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/05-deploy.yml
    secrets: inherit
    with:
      commit-sha: ${{ github.sha }}
      site-url: 'https://management-app-demo.netlify.app'