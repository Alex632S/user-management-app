setup:
  runs-on: ubuntu-latest
  outputs:
    cache-key: ${{ steps.cache-key.outputs.key }}
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Generate cache key
      id: cache-key
      run: echo "key=${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}-$(date +%W)" >> $GITHUB_OUTPUT
      
    - name: Cache dependencies
      uses: actions/cache@v4
      id: cache
      with:
        path: |
          node_modules
          .nuxt
        key: ${{ steps.cache-key.outputs.key }}
        
    - name: Install dependencies
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        npm install --legacy-peer-deps
        # Обновляем unplugin если нужно
        npm install unplugin@1.10.1 --save-dev
        
    - name: Generate Nuxt types
      run: |
        # Очищаем .nuxt перед генерацией
        rm -rf .nuxt
        npx nuxt prepare
      env:
        NODE_OPTIONS: --max-old-space-size=4096