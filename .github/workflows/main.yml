name: Main CI/CD Pipeline

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]


concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    name: üì¶ Setup & Cache
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.final-key.outputs.key }}
      node-version: ${{ steps.node-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          
      - name: Setup Node.js
        id: setup-node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'  # –í—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ npm
          
      - name: Save Node version
        id: node-version
        run: echo "version=$(node --version)" >> $GITHUB_OUTPUT
      
      - name: Calculate cache key (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
        id: calc-key
        run: |
          KEY="${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}-$(node --version)"
          echo "key=$KEY" >> $GITHUB_OUTPUT
          echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á: $KEY"
          
      - name: Cache node_modules
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ steps.calc-key.outputs.key }}
          restore-keys: |
            ${{ runner.os }}-node-
            
      - name: Install dependencies (–µ—Å–ª–∏ –Ω–µ—Ç –∫–µ—à–∞)
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          echo "‚ö†Ô∏è –ö–µ—à –Ω–µ –Ω–∞–π–¥–µ–Ω, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
          npm ci --prefer-offline --no-audit --no-fund
        env:
          NODE_ENV: development
          
      - name: Verify installation
        run: |
          echo "‚úÖ Node: $(node --version)"
          echo "‚úÖ NPM: $(npm --version)"
          echo "‚úÖ –ú–æ–¥—É–ª–∏: $(ls node_modules | wc -l) –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π"
          
      - name: Set final cache key (–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ)
        id: final-key
        run: |
          # –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–π –∫–ª—é—á, –¥–∞–∂–µ –µ—Å–ª–∏ cache –Ω–µ –≤–µ—Ä–Ω—É–ª –∫–ª—é—á
          FINAL_KEY="${{ steps.calc-key.outputs.key }}"
          echo "key=$FINAL_KEY" >> $GITHUB_OUTPUT
          echo "‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π –∫–ª—é—á –∫–µ—à–∞: $FINAL_KEY"
          
      - name: Generate Nuxt types
        run: npx nuxt prepare
        continue-on-error: true  # –ù–µ –ø–∞–¥–∞–µ–º, –µ—Å–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–∏–ø–æ–≤ –Ω–µ —É–¥–∞–ª–∞—Å—å
      
      - name: Upload debug info
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: setup-debug-${{ github.sha }}
          path: |
            package.json
            package-lock.json
            .nuxt/
          retention-days: 3

  lint:
    name: üîç Lint & Typecheck
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Calculate cache key (–¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è)
        id: calc-key
        run: |
          KEY="${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}-$(node --version)"
          echo "key=$KEY" >> $GITHUB_OUTPUT
          
      - name: Restore cache (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏)
        uses: actions/cache@v4
        continue-on-error: true
        id: restore-cache
        with:
          path: node_modules
          key: ${{ steps.calc-key.outputs.key }}
          restore-keys: |
            ${{ runner.os }}-node-
            
      - name: Install if no cache
        if: steps.restore-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit
          
      - name: Generate Nuxt types
        run: npx nuxt prepare
        continue-on-error: true
        
      - name: TypeScript check (—Å —Ñ–ª–∞–≥–æ–º –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫)
        run: npm run typecheck || echo "‚ö†Ô∏è TypeScript –æ—à–∏–±–∫–∏, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º"
        continue-on-error: true
        
      - name: ESLint (–∞–≤—Ç–æ–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
        run: npm run lint || echo "‚ö†Ô∏è –õ–∏–Ω—Ç–µ—Ä –≤—ã–¥–∞–ª –æ—à–∏–±–∫–∏, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º"
        continue-on-error: true
        
      - name: Upload lint results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-results-${{ github.sha }}
          path: |
            .eslintcache
            *.log
          retention-days: 3

  test:
    name: üß™ Tests
    needs: [setup, lint]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        shard: [1, 2, 3]  # –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ—Å—Ç—ã –Ω–∞ 3 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–∞
      fail-fast: false  # –ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥—Ä—É–≥–∏–µ —à–∞—Ä–¥—ã –ø—Ä–∏ –æ—à–∏–±–∫–µ
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Calculate cache key
        run: echo "key=${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}" >> $GITHUB_ENV
          
      - name: Restore cache (—Å retry)
        uses: actions/cache@v4
        continue-on-error: true
        with:
          path: node_modules
          key: ${{ env.key }}
          
      - name: Install dependencies if needed
        if: steps.restore-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline
          
      - name: Generate Nuxt types
        run: npx nuxt prepare
        
      - name: Run tests (—à–∞—Ä–¥ ${{ matrix.shard }})
        id: tests
        run: |
          npm run test -- --shard=${{ matrix.shard }}/${{ strategy.job-total }} || echo "TESTS_FAILED=true" >> $GITHUB_ENV
        continue-on-error: true
        
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.shard }}-${{ github.sha }}
          path: |
            coverage/
            test-results/
          retention-days: 7
          
  test-report:
    name: üìä Test Report
    needs: test
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check test status
        run: |
          if [[ "${{ needs.test.result }}" == "failure" ]]; then
            echo "‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏"
            exit 1
          else
            echo "‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏"
          fi

  build:
    name: üèóÔ∏è Build
    needs: [setup, test-report]
    runs-on: ubuntu-latest
    outputs:
      build-status: ${{ steps.build.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Calculate cache key
        run: echo "key=${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}" >> $GITHUB_ENV
          
      - name: Restore cache (—Å retry)
        uses: actions/cache@v4
        continue-on-error: true
        with:
          path: node_modules
          key: ${{ env.key }}
          
      - name: Install dependencies if needed
        if: steps.restore-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline
        
      - name: Build project (—Å –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π)
        id: build
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          command: npm run build
          retry_on: error
          
      - name: Prepare artifacts
        run: |
          mkdir -p dist
          cp -r .output dist/ || echo "‚ö†Ô∏è .output –Ω–µ –Ω–∞–π–¥–µ–Ω"
          cp package.json dist/
          echo "${{ github.sha }}" > dist/COMMIT
          echo "${{ github.ref }}" > dist/BRANCH
          date > dist/BUILD_TIME
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ github.sha }}
          path: dist/
          retention-days: 30
          compression-level: 6
          
  deploy:
    name: üöÄ Deploy
    needs: [build, test-report]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    outputs:
      deploy-status: ${{ steps.deploy.outcome }}
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-${{ github.sha }}
          path: dist
          
      - name: Verify artifacts
        run: |
          if [ ! -d "dist" ]; then
            echo "‚ùå –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!"
            exit 1
          fi
          echo "‚úÖ –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:"
          ls -la dist/
          
      - name: Deploy to Netlify (—Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏)
        id: deploy
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          command: |
            npx netlify-cli deploy --dir=dist --prod --message="Deploy ${{ github.sha }}"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        continue-on-error: true
        
      - name: Health check (—Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏)
        if: steps.deploy.outcome == 'success'
        run: |
          URL="${{ steps.deploy.outputs.url }}"
          for i in {1..5}; do
            echo "–ü–æ–ø—ã—Ç–∫–∞ $i: –ø—Ä–æ–≤–µ—Ä–∫–∞ $URL"
            if curl -f -I --max-time 10 "$URL"; then
              echo "‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω!"
              exit 0
            fi
            echo "‚è≥ –ñ–¥–µ–º 5 —Å–µ–∫—É–Ω–¥..."
            sleep 5
          done
          echo "‚ùå –°–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ 5 –ø–æ–ø—ã—Ç–æ–∫"
          exit 1
        continue-on-error: true
        
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          body_path: dist/CHANGELOG.md
          generate_release_notes: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
  notify:
    name: üì¢ Notify
    needs: [deploy, build, test, lint]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check status
        run: |
          echo "## üìä –°—Ç–∞—Ç—É—Å –ø–∞–π–ø–ª–∞–π–Ω–∞" > status.md
          echo "| Job | Status |" >> status.md
          echo "|-----|--------|" >> status.md
          echo "| Setup | ${{ needs.setup.result }} |" >> status.md
          echo "| Lint | ${{ needs.lint.result }} |" >> status.md
          echo "| Test | ${{ needs.test.result }} |" >> status.md
          echo "| Build | ${{ needs.build.result }} |" >> status.md
          echo "| Deploy | ${{ needs.deploy.result }} |" >> status.md
          
      - name: Upload status
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-status-${{ github.sha }}
          path: status.md
          
      - name: Send notification (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        if: failure()
        run: |
          echo "‚ùå –ü–∞–π–ø–ª–∞–π–Ω —É–ø–∞–ª!"
          # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –≤ Slack/Telegram/Email