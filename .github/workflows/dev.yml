name: Dev CI

on:
  push:
    branches: [dev]
    paths-ignore:
      - "**.md"
      - ".vscode/**"
  pull_request:
    branches: [dev]
    paths-ignore:
      - "**.md"

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    name: Environment · Setup
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.final-key.outputs.key }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Calculate cache key
        id: calc-key
        run: |
          KEY="${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}"
          echo "key=$KEY" >> $GITHUB_OUTPUT

      - name: Cache node_modules
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ steps.calc-key.outputs.key }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies (if no cache)
        if: steps.cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit --no-fund
        env:
          NODE_ENV: development

      - name: Set final cache key
        id: final-key
        run: echo "key=${{ steps.calc-key.outputs.key }}" >> $GITHUB_OUTPUT

      - name: Generate Nuxt types
        run: npx nuxt prepare
        continue-on-error: true

  lint:
    name: Lint & Typecheck
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: TypeScript check
        run: npm run typecheck
        continue-on-error: false

      - name: ESLint
        run: npm run lint
        continue-on-error: false

  test:
    name: Tests
    needs: [setup, lint]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        shard: [1, 2]
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Generate Nuxt types
        run: npx nuxt prepare

      - name: Run tests
        run: npm run test -- --shard=${{ matrix.shard }}/${{ strategy.job-total }}
        continue-on-error: false

  test-report:
    name: Test Report
    needs: test
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check test status
        run: |
          if [[ "${{ needs.test.result }}" == "failure" ]]; then
            echo "Тесты провалились!"
            exit 1
          else
            echo "Все тесты прошли успешно!"
          fi

  build:
    name: Build (Preview)
    needs: [setup, test-report]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Clean previous build
        run: |
          rm -rf .nuxt .output dist .netlify/functions-internal

      - name: Build project for preview
        run: npm run build
        env:
          NITRO_PRESET: netlify
          NODE_ENV: development
          BUILD_ENV: preview
          BUILD_COMMIT: ${{ github.sha }}
          BUILD_REF: ${{ github.ref }}

      - name: Verify build output
        run: |
          echo "Проверка структуры сборки (dev):"

          if [ -d "dist" ]; then
            echo "Папка dist найдена"
            echo "Содержит $(find dist -type f | wc -l) файлов"
            echo "Содержимое dist:"
            ls -la dist/ | head -10
          else
            echo "Папка dist не найдена!"
            exit 1
          fi

          if [ -d ".netlify/functions-internal" ]; then
            echo "Папка функций найдена"
            echo "Содержит $(find .netlify/functions-internal -type f | wc -l) файлов"
          else
            echo "Папка функций не найдена"
          fi

      - name: Upload build artifacts (for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: build-dev-${{ github.sha }}
          path: |
            dist
            .netlify/functions-internal
            netlify.toml
          retention-days: 7
          if-no-files-found: warn

  summary:
    name: Summary
    needs: [lint, test, build]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Display results
        run: |
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "Сборка прошла успешно!"
          else
            echo "Сборка провалилась!"
            exit 1
          fi
