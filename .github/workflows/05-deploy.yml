name: Deploy Job

on:
  workflow_call:
    inputs:
      commit-sha:
        required: true
        type: string
      site-url:
        required: true
        type: string
    secrets:
      NETLIFY_AUTH_TOKEN:
        required: true
      NETLIFY_SITE_ID:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ inputs.site-url }}
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: netlify-build-${{ inputs.commit-sha }}
          path: ./deploy
          
      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: './deploy/.netlify/functions-internal'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy ${{ inputs.commit-sha }}"
          enable-pull-request-comment: true
          enable-commit-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          
      - name: Health check
        run: |
          echo "=== üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∞–π—Ç–∞ ==="
          curl -I ${{ inputs.site-url }}
          echo "‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω!"
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          body: |
            ## üöÄ –†–µ–ª–∏–∑ v${{ github.run_number }}
            - **Commit:** ${{ inputs.commit-sha }}
            - **–°–∞–π—Ç:** ${{ inputs.site-url }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}