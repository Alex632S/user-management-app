deploy:
  name: ‚ë£ Deploy ¬∑ Netlify
  needs: [setup, test, build]
  runs-on: ubuntu-latest
  environment:
    name: production
    url: ${{ steps.deploy.outputs.url }}
  steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-production-${{ github.sha }}
        path: .

    - name: Verify downloaded artifacts
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤:"
        ls -la
        if [ ! -d "dist" ]; then
          echo "‚ùå dist/ –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          exit 1
        fi

    - name: Install Netlify CLI
      run: npm install -g netlify-cli --no-fund

    - name: Deploy to Netlify
      id: deploy
      run: |
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–µ–ø–ª–æ—è (–∫–∞–∫ –≤ –≤–∞—à–µ–º —Ä–∞–±–æ—á–µ–º –∫–æ–¥–µ)
        DEPLOY_ARGS="--dir=dist --prod --message=Deploy ${{ github.sha }}"

        # –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
        if [ -d ".netlify/functions-internal" ]; then
          DEPLOY_ARGS="$DEPLOY_ARGS --functions=.netlify/functions-internal"
          echo "‚ö° –§—É–Ω–∫—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ .netlify/functions-internal"
        fi

        echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ–ø–ª–æ–π: netlify deploy $DEPLOY_ARGS"

        # –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–ø–ª–æ–π –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–≤–æ–¥
        npx netlify-cli deploy $DEPLOY_ARGS 2>&1 | tee deploy-output.log

        # –ü–∞—Ä—Å–∏–º URL –∏–∑ –≤—ã–≤–æ–¥–∞
        URL=$(cat deploy-output.log | grep -oP 'https://[a-zA-Z0-9.-]+\.netlify\.app' | head -1)

        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–æ–π –ø–∞—Ç—Ç–µ—Ä–Ω
        if [ -z "$URL" ]; then
          URL=$(cat deploy-output.log | grep -oP 'https://[^\s]+' | grep netlify | head -1)
        fi

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º URL
        echo "url=$URL" >> $GITHUB_OUTPUT
        echo "‚úÖ –î–µ–ø–ª–æ–π –≤—ã–ø–æ–ª–Ω–µ–Ω"
        echo "üåç URL: $URL"

        # –í—Å–µ–≥–¥–∞ –≤—ã—Ö–æ–¥–∏–º —Å —É—Å–ø–µ—Ö–æ–º, –¥–∞–∂–µ –µ—Å–ª–∏ URL –Ω–µ –Ω–∞—à–µ–ª—Å—è
        exit 0
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

    - name: Health check
      if: success()
      run: |
        URL="${{ steps.deploy.outputs.url }}"

        if [ -z "$URL" ] || [ "$URL" = "null" ]; then
          echo "‚ö†Ô∏è URL –Ω–µ –ø–æ–ª—É—á–µ–Ω, –Ω–æ –¥–µ–ø–ª–æ–π –≤–µ—Ä–æ—è—Ç–Ω–æ —É—Å–ø–µ—à–µ–Ω"
          exit 0
        fi

        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: $URL"

        for i in {1..10}; do
          echo "‚è≥ –ü–æ–ø—ã—Ç–∫–∞ $i/10..."
          
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$URL" 2>/dev/null || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "301" ] || [ "$HTTP_STATUS" = "302" ]; then
            echo "‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω! (HTTP $HTTP_STATUS)"
            exit 0
          fi
          
          echo "‚è≥ –°—Ç–∞—Ç—É—Å: $HTTP_STATUS, –∂–¥–µ–º 5 —Å–µ–∫—É–Ω–¥..."
          sleep 5
        done

        echo "‚ö†Ô∏è –°–∞–π—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç, –Ω–æ –¥–µ–ø–ª–æ–π –≤—ã–ø–æ–ª–Ω–µ–Ω"
