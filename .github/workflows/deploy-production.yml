deploy:
  name: â‘£ Deploy Â· Netlify
  needs: [setup, test, build]
  runs-on: ubuntu-latest
  environment:
    name: production
    url: ${{ steps.deploy.outputs.url }}
  steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-production-${{ github.sha }}
        path: . # â­ Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€ÑÐ¼Ð¾ Ð² Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ

    - name: Verify downloaded artifacts
      run: |
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²:"
        ls -la

        if [ ! -d "dist" ]; then
          echo "âŒ dist/ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
          exit 1
        fi

    - name: Install Netlify CLI
      run: npm install -g netlify-cli --no-fund

    - name: Deploy to Netlify
      id: deploy
      run: |
        # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ ÐºÐ°Ðº Ð² Ð¸ÑÑ…Ð¾Ð´Ð½Ð¾Ð¼ Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½Ðµ
        DEPLOY_ARGS="--dir=dist --prod --message=Deploy ${{ github.sha }}"

        if [ -d ".netlify/functions-internal" ]; then
          DEPLOY_ARGS="$DEPLOY_ARGS --functions=.netlify/functions-internal"
          echo "âš¡ Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð² .netlify/functions-internal"
        fi

        echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼: netlify deploy $DEPLOY_ARGS"

        # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð²Ñ‹Ð²Ð¾Ð´
        npx netlify-cli deploy $DEPLOY_ARGS 2>&1 | tee deploy-output.log

        # ÐŸÐ°Ñ€ÑÐ¸Ð¼ URL
        URL=$(cat deploy-output.log | grep -oP 'https://[a-zA-Z0-9.-]+\.netlify\.app' | head -1)
        if [ -z "$URL" ]; then
          URL=$(cat deploy-output.log | grep -oP 'https://[^\s]+' | grep netlify | head -1)
        fi

        echo "url=$URL" >> $GITHUB_OUTPUT
        echo "âœ… URL: $URL"
        exit 0
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
