name: Deploy Production

on:
  workflow_call:
    inputs:
      sha:
        required: true
        type: string
        description: "Commit SHA to deploy"
    outputs:
      url:
        description: "Deployed URL"
        value: ${{ jobs.deploy.outputs.url }}

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: Deploy · Netlify
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-production-${{ inputs.sha }}
          path: .

      - name: Verify downloaded artifacts
        run: |
          echo "Проверка артефактов:"
          if [ -d "dist" ]; then
            echo "dist/ найден"
            ls -la dist/
          else
            echo "dist/ не найден!"
            exit 1
          fi

      - name: Install Netlify CLI
        run: npm install -g netlify-cli --no-fund

      - name: Deploy to Netlify
        id: deploy
        run: |
          # Формируем параметры деплоя
          DEPLOY_ARGS="--dir=dist --prod --message=Deploy ${{ inputs.sha }}"

          # Добавляем функции если есть
          if [ -d ".netlify/functions-internal" ]; then
            DEPLOY_ARGS="$DEPLOY_ARGS --functions=.netlify/functions-internal"
            echo "Функции найдены в .netlify/functions-internal"
          fi

          echo "Запускаем деплой: netlify deploy $DEPLOY_ARGS"

          # Выполняем деплой и сохраняем вывод
          npx netlify-cli deploy $DEPLOY_ARGS 2>&1 | tee deploy-output.log

          # Парсим URL из вывода
          URL=$(cat deploy-output.log | grep -oP 'https://[a-zA-Z0-9.-]+\.netlify\.app' | head -1)

          # Если не нашли, пробуем другой паттерн
          if [ -z "$URL" ]; then
            URL=$(cat deploy-output.log | grep -oP 'https://[^\s]+' | grep netlify | head -1)
          fi

          # Сохраняем URL
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Деплой выполнен: $URL"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Health check
        run: |
          URL="${{ steps.deploy.outputs.url }}"

          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "URL не получен, проверьте деплой вручную"
            exit 0
          fi

          echo "Проверка доступности: $URL"

          for i in {1..10}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$URL" 2>/dev/null || echo "000")
            if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "301" ] || [ "$HTTP_STATUS" = "302" ]; then
              echo "Сайт доступен (HTTP $HTTP_STATUS)"
              exit 0
            fi
            echo "Попытка $i/10: статус $HTTP_STATUS"
            sleep 5
          done

          echo "Сайт не отвечает, но деплой выполнен"
